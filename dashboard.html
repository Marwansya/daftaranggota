<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Anggota</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    @media print {
      h2, input, select, .controls, button {
        display: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
    }
  </style>
</head>
<body>
  <h2>Daftar Anggota</h2>
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Cari anggota...">
    <select id="filterSelect">
      <option value="">Semua</option>
      <option value="Mariadei">Mariadei</option>
      <option value="Menawi">Menawi</option>
      <option value="Aromarea">Aromarea</option>
      <option value="Anotaurei">Anotaurei</option>
    </select>
    <button id="addBtn">Tambah Anggota</button>
  </div>

  <div id="noData" style="display:none;">Tidak ada anggota ditemukan.</div>

  <table>
    <thead>
      <tr class="teks-gradient">
        <th>No</th><th>Nama</th><th>Resort</th><th>Detail</th>
      </tr>
    </thead>
    <tbody id="anggotaList"></tbody>
  </table>

  <div class="print">
    <button onclick="window.print()">Cetak</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZTjmiy6ggJQwhEjGOlxBnpKp-O4B2BZQ",
      authDomain: "berkah-abadi-tunggal.firebaseapp.com",
      projectId: "berkah-abadi-tunggal",
      storageBucket: "berkah-abadi-tunggal.appspot.com",
      messagingSenderId: "481882897013",
      appId: "1:481882897013:web:163f26b6e1778743f5963c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const anggotaList = document.getElementById("anggotaList");
    const searchInput = document.getElementById("searchInput");
    const filterSelect = document.getElementById("filterSelect");
    const addBtn = document.getElementById("addBtn");
    const noData = document.getElementById("noData");

    const paginationDiv = document.createElement("div");
    paginationDiv.id = "pagination";
    paginationDiv.style.marginTop = "10px";
    paginationDiv.style.textAlign = "center";
    document.body.appendChild(paginationDiv);

    let lastVisible = null;
    let currentPage = 1;
    let pageStack = []; // simpan posisi awal tiap halaman

    // Cek login
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Silakan login terlebih dahulu!");
        window.location.href = "login.html";
      } else {
        loadAnggota();
      }
    });

    addBtn.addEventListener("click", () => window.location.href = "tambah_anggota.html");

    async function loadAnggota(next = false, prev = false) {
      anggotaList.innerHTML = "";
      noData.style.display = "none";
      paginationDiv.innerHTML = "";

      try {
        let filter = filterSelect.value;
        let search = searchInput.value.toLowerCase();

        let baseQuery = filter
          ? query(collection(db, "anggota"), where("resort", "==", filter))
          : collection(db, "anggota");

        let q = query(baseQuery, orderBy("nama"), limit(20));

        // next page
        if (next && lastVisible) {
          q = query(baseQuery, orderBy("nama"), startAfter(lastVisible), limit(20));
        }

        // prev page
        if (prev && currentPage > 1) {
          currentPage--;
          let prevStart = pageStack[currentPage - 1];
          q = query(baseQuery, orderBy("nama"), startAfter(prevStart), limit(20));
        }

        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          noData.style.display = "block";
          return;
        }

        lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
        if (pageStack.length < currentPage) {
          pageStack.push(querySnapshot.docs[0]);
        }

        querySnapshot.forEach(docItem => {
          const data = docItem.data();
          if ((data.nama && data.nama.toLowerCase().includes(search)) ||
              (data.noanggota && data.noanggota.toLowerCase().includes(search))
          ) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.noanggota}</td>
              <td>${data.nama}</td>
              <td>${data.resort || "-"}</td>
              <td><button class="detailBtn" onclick="window.location.href='detail_anggota.html?id=${docItem.id}'">Lihat</button></td>
            `;
            anggotaList.appendChild(row);
          }
        });

        // Buat pagination
        let prevBtn = document.createElement("button");
        prevBtn.innerText = "Prev";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { loadAnggota(false, true); };

        let nextBtn = document.createElement("button");
        nextBtn.innerText = "Next";
        nextBtn.onclick = () => { currentPage++; loadAnggota(true, false); };

        paginationDiv.appendChild(prevBtn);

        // angka halaman (tampilkan max 5 halaman ke depan)
        for (let i = 1; i <= currentPage + 2; i++) {
          let btn = document.createElement("button");
          btn.innerText = i;
          btn.style.margin = "0 3px";
          if (i === currentPage) {
            btn.disabled = true;
            btn.style.fontWeight = "bold";
            btn.classList.add("active");
          }
          btn.onclick = async () => {
            currentPage = i;
            pageStack = []; // reset
            await reloadPage(i);
          };
          paginationDiv.appendChild(btn);
        }

        paginationDiv.appendChild(nextBtn);

      } catch (err) {
        console.error("Error load anggota:", err);
        noData.innerText = "Gagal memuat data. Periksa console.";
        noData.style.display = "block";
      }
    }

    // reload ke halaman tertentu (jalan sequential dari awal)
    async function reloadPage(targetPage) {
      anggotaList.innerHTML = "Loading...";
      let filter = filterSelect.value;
      let baseQuery = filter
        ? query(collection(db, "anggota"), where("resort", "==", filter))
        : collection(db, "anggota");

      let q = query(baseQuery, orderBy("nama"), limit(20));
      let snapshot;

      pageStack = [];

      for (let i = 1; i <= targetPage; i++) {
        snapshot = await getDocs(q);
        if (snapshot.empty) break;
        if (i < targetPage) {
          let last = snapshot.docs[snapshot.docs.length - 1];
          q = query(baseQuery, orderBy("nama"), startAfter(last), limit(20));
          pageStack.push(snapshot.docs[0]);
        }
      }

      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      anggotaList.innerHTML = "";
      snapshot.forEach(docItem => {
        const data = docItem.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.noanggota}</td>
          <td>${data.nama}</td>
          <td>${data.resort || "-"}</td>
          <td><button class="detailBtn" onclick="window.location.href='detail_anggota.html?id=${docItem.id}'">Lihat</button></td>
        `;
        anggotaList.appendChild(row);
      });

      loadAnggota(); // refresh tombol pagination
    }

    searchInput.addEventListener("input", () => { currentPage = 1; pageStack = []; loadAnggota(); });
    filterSelect.addEventListener("change", () => { currentPage = 1; pageStack = []; loadAnggota(); });
  </script>
</body>
</html>
